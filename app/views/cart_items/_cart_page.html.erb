<%= turbo_stream_from cart_stream_name %>
<div id="cart_dropdown">
  <% cart_hash = session[:cart] || {} %>
  <% if session[:cart_token] %>
    <% cart = Cart.find_by(token: session[:cart_token]) %>
    <% items = cart ? cart.cart_items.includes(:product) : [] %>
  <% else %>
    <% product_ids = cart_hash.keys %>
    <% items = Product.where(id: product_ids).map { |p| OpenStruct.new(product: p, quantity: cart_hash[p.id.to_s].to_i) } %>
  <% end %>

  <% if items.blank? %>
    <div class="text-sm text-gray-400">Your cart is empty.</div>
  <% else %>
    <div class="grid grid-cols-1 gap-4">
      <% items.each do |it| %>
        <div class="flex items-center gap-4 p-4 bg-gray-800 rounded" data-cart-item>
          <div class="w-28 h-20 bg-gray-700 rounded overflow-hidden flex-shrink-0">
            <% if it.product.image.attached? %>
              <%= image_tag it.product.image.variant(resize_to_fill: [280,160]), class: "w-full h-full object-cover" %>
            <% else %>
              <div class="w-full h-full flex items-center justify-center text-gray-400 text-sm">No image</div>
            <% end %>
          </div>

          <div class="flex-1">
            <div class="flex items-start justify-between">
              <div>
                <div class="text-lg font-semibold text-white"><%= link_to it.product.name, product_path(it.product), data: { turbo_frame: "" } %></div>
                <div class="text-sm text-gray-400"><%= truncate(it.product.description, length: 120) %></div>
              </div>
              <div class="text-right">
                <div class="text-indigo-300 font-semibold"><%= number_to_currency(it.product.price) %></div>
                <div class="text-sm text-gray-400">Subtotal: <span class="text-white font-semibold"><%= number_to_currency(it.product.price * it.quantity) %></span></div>
              </div>
            </div>

            <div class="mt-3 flex items-center justify-between">
              <div class="flex items-center gap-2">
                <div class="text-sm text-gray-300">Qty: <span class="font-semibold" data-cart-quantity><%= it.quantity %></span></div>
                <%= form_with url: cart_items_path, method: :post, local: false, class: 'inline', data: { controller: 'cart', action: 'submit->cart#add' } do |f| %>
                  <%= hidden_field_tag :product_id, it.product.id %>
                  <%= number_field_tag :quantity, 1, min: 1, max: [5, it.product.stock_quantity.to_i].min, class: 'w-16 text-sm rounded bg-gray-800 text-white px-2 py-1' %>
                  <%= f.submit 'Add', class: 'ml-2 px-2 py-1 bg-indigo-600 rounded text-sm' %>
                <% end %>
              </div>

              <div class="flex items-center gap-3">
                <%= button_to 'Remove', cart_items_path(product_id: it.product.id), method: :delete, form: { data: { turbo: true, controller: 'cart', action: 'submit->cart#remove' } }, class: 'text-sm text-red-400' %>
              </div>
            </div>
          </div>
        </div>
      <% end %>
    </div>

    <div class="mt-6 flex items-center justify-between">
      <div class="text-sm text-gray-300">Total</div>
      <div class="text-xl text-white font-bold"><%= number_to_currency(items.sum { |it| it.product.price * it.quantity }) %></div>
    </div>

    <div class="mt-4 grid grid-cols-1 md:grid-cols-2 gap-3">
      <%= button_to 'Checkout', checkout_path, method: :post, class: 'w-full inline-flex justify-center py-3 px-4 bg-indigo-600 text-white rounded', form: { data: { turbo: true } } %>
      <%= link_to 'Continue shopping', products_path, class: 'w-full inline-flex justify-center py-3 px-4 border border-gray-700 rounded text-sm text-gray-300' %>
    </div>
  <% end %>
</div>
